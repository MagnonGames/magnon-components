<link rel="import" href="../element.html">
<link rel="import" href="../magnon-styles/magnon-styles.html">
<link rel="import" href="../magnon-icon/magnon-icon.html">
<link rel="import" href="../magnon-icon-button/magnon-icon-button.html">


<template id="magnon-notifications">
    <style>
        :host {
            display: flex;
            position: fixed;
            top: 0; right: 0; bottom: 0; left: 0;
            z-index: 1000;
            pointer-events: none;
            flex-direction: column;
            align-items: flex-start;
            justify-content: flex-end;

            padding: 20px 40px;
        }

        ::slotted(magnon-notification) {
            flex-shrink: 0;
            max-width: 30%;
        }
    </style>

    <slot></slot>
</template>

<template id="magnon-notification">
    <style>
        :host {
            position: relative;
            display: flex;
            pointer-events: all;
            min-width: 350px;

            background: var(--magnon-black);
            color: white;
            font-family: var(--magnon-font);

            border-radius: 4px;

            opacity: 0;

            margin: 10px 0;

            animation: 0.3s ease-out 0.4s 1 notification-in;
            transition: 0.2s all;
        }

        .close-button {
            opacity: 0.5;
            position: absolute;
            top: 5px;
            right: 5px;
            --magnon-icon-color: white;

            transition: 0.5s opacity;
        }

        :host(:hover) .close-button {
            opacity: 1;
        }

        #left {
            padding: 20px;
        }

        #icon {
            --magnon-icon-color: var(--magnon-notification-color, white);
            --magnon-icon-size: 48px;
        }

        #right {
            flex-grow: 1;
            padding: 17px 20px 17px 10px;
        }

        #title {
            display: block;
            color: var(--magnon-notification-color);

            font-size: 18px;
            font-weight: bold;

            margin-bottom: 10px;
        }

        @keyframes notification-in {
            from {
                transform: translateY(150%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>

    <div id="left">
        <div id="icon"><slot name="icon"></slot></div>
    </div>
    <div id="right">
        <span id="title"><slot name="title"></slot></span>
        <div id="content"><slot></slot></div>
    </div>

    <magnon-icon-button icon="cross" class="close-button"></magnon-icon-button>
</template>

<script>
    /* globals MagnonElement */
    window.MagnonNotifications = class extends MagnonElement {
        static appendToBody() {
            const append = () => {
                const notificationContainer = document.createElement("magnon-notifications");
                this.notificationContainer = notificationContainer;
                document.body.appendChild(notificationContainer);
            };

            if (document.readyState !== "loading") {
                append();
            } else {
                document.addEventListener("DOMContentLoaded", () => append());
            }
        }

        static send(template) {
            if (typeof template !== "string") {
                const instance = template.content.cloneNode(true);
                this.notificationContainer.appendChild(instance);
            } else {
                this.notificationContainer.innerHTML += template;
            }

            const notifications = this.notificationContainer.querySelectorAll("magnon-notification");
            return notifications[notifications.length - 1];
        }

        static get name() {
            return "magnon-notifications";
        }
    };

    class MagnonNotification extends MagnonElement {
        constructor() {
            super();

            const margin = window.getComputedStyle(this).margin;

            this.style.transition = "none";
            this.style.height = "0px";
            this.style.margin = "0px 0px";

            this.root.querySelector(".close-button").addEventListener("click", () => this.close());

            setTimeout(() => {
                this.style.height = "";
                const height = this.offsetHeight;

                this.style.height = "0px";

                setTimeout(() => {
                    this.style.transition = "";

                    this.style.margin = margin;
                    this.style.height = `${height}px`;

                    this.addEventListener("animationstart", () => {
                        this.style.opacity = 1;
                    });
                }, 100);
            }, 100);
        }

        static get name() {
            return "magnon-notification";
        }

        static get propertyAttributes() {
            return {
                string: ["color"]
            };
        }

        propertySet(property, old, value) {
            if (property === "color") {
                const newValue = value.startsWith("--") ? `var(${value})` : value;
                this.style.setProperty("--magnon-notification-color", newValue);
            }
        }

        close() {
            this.fire("close");

            this.style.transform = "scaleY(0)";
            const end = () => {
                this.style.height = "0px";
                this.style.margin = "0px";
                this.removeEventListener("transitionend", end);
                const newEnd = () => {
                    this.parentElement.removeChild(this);
                    this.removeEventListener("transitionend", newEnd);
                };
                this.addEventListener("transitionend", newEnd);
            };
            this.addEventListener("transitionend", end);
        }
    }

    window.MagnonNotifications.init();
    window.MagnonNotifications.appendToBody();
    MagnonNotification.init();
</script>
