<link rel="import" href="../element.html">
<link rel="import" href="../magnon-styles/magnon-styles.html">

<template id="magnon-image">
    <style>
        :host {
            display: inline-block;
        }

        #main-image {
            border-radius: var(--magnon-image-border-radius);

            transition: 0.3s opacity;
        }

        #fullscreen-container {
            position: fixed;
            top: 0; right: 0; bottom: 0; left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;

            z-index: 100000;
            pointer-events: none;
        }

        #fullscreen-backdrop {
            position: absolute;
            width: 100%;
            height: 100%;
            background: var(--magnon-black-blue);

            transition: 0.3s opacity ease-out;
        }

        #fullscreen-image {
            z-index: 1;
            width: 80%;
            height: auto;

            transform-origin: top left;
            transition: all 0.3s ease-out;
        }

        #fullscreen-image.tall {
            width: auto;
            height: 80%;
        }
    </style>

    <div id="image-container">
        <img id="main-image"></img>
    </div>

    <div id="fullscreen-container">
        <span id="fullscreen-backdrop"></span>
        <img id="fullscreen-image"></img>
    </div>
</template>

<script>
    /* globals MagnonElement */
    class MagnonImage extends MagnonElement {
        constructor() {
            super();

            this._fullscreenEnabled = true;

            this._image = this.root.querySelector("#main-image");

            this._fullscreenContainer = this.root.querySelector("#fullscreen-container");
            this._fullscreenBackdrop = this.root.querySelector("#fullscreen-backdrop");
            this._fullscreenImage = this.root.querySelector("#fullscreen-image");

            this._image.addEventListener("load", () => this._updateImageSize());
            this._image.addEventListener("click", () => (this.fullscreen = true));
            this._fullscreenBackdrop.addEventListener("click", () => (this.fullscreen = false));

            window.addEventListener("resize", () => this._updateImageSize());

            this.fullscreen = false;
        }

        static get name() {
            return "magnon-image";
        }

        static get observedAttributes() {
            return ["src", "alt", "no-fullscreen"];
        }

        set fullscreen(value) {
            if (value && !this._fullscreenEnabled) return;

            if (value) {
                this._fullscreenImage.style.opacity = "1";
                this._fullscreenBackdrop.style.opacity = "0.7";

                this._image.style.transition = "none";
                this._image.style.opacity = "0";

                const startBox = this._image.getBoundingClientRect();
                const startBorderRadius = window.getComputedStyle(this._image).getPropertyValue("border-radius");
                const endBox = this._fullscreenImage.getBoundingClientRect();

                this._fullscreenImage.style.transition = "none";

                this._fullscreenImage.style.transform = `
                    translate(${startBox.left - endBox.left}px, ${startBox.top - endBox.top}px)
                    scale(${startBox.width / endBox.width}, ${startBox.height / endBox.height})
                `;

                this._fullscreenImage.style.borderRadius = startBorderRadius;

                setTimeout(() => {
                    this._fullscreenImage.style.transition = "";

                    this._fullscreenImage.style.transform = `
                        translate(0px, 0px)
                        scale(1, 1)
                    `;

                    this._fullscreenImage.style.borderRadius = "0";

                    const endAction = () => {
                        this._fullscreenContainer.style.pointerEvents = "all";
                        this._fullscreenImage.removeAttribute("style");
                        this._fullscreenImage.removeEventListener("transitionend", endAction);

                        this._image.style.transition = "";
                    };
                    this._fullscreenImage.addEventListener("transitionend", endAction);
                }, 100);
            } else {
                const endAction = () => {
                    this._fullscreenContainer.style.pointerEvents = "none";
                    this._fullscreenBackdrop.removeEventListener("transitionend", endAction);
                };

                const opacity = window.getComputedStyle(this._fullscreenBackdrop).getPropertyValue("opacity");
                if (opacity !== "") {
                    this._fullscreenBackdrop.addEventListener("transitionend", endAction);
                }

                this._fullscreenImage.style.opacity = "0";
                this._fullscreenBackdrop.style.opacity = "0";
                this._image.style.opacity = "1";
            }
        }

        attributeChangedCallback(attribute, old, value) {
            if (attribute === "src") {
                this._image.src = value;
                this._fullscreenImage.src = value;
            } else if (attribute === "alt") {
                this._image.alt = value;
                this._fullscreenImage.alt = value;
            } else if (attribute === "no-fullscreen") {
                this._fullscreenEnabled = !this.hasAttribute("no-fullscreen");
            }
        }

        _updateImageSize() {
            const width = window.innerWidth;
            const height = window.innerHeight;
            const imageWidth = this._image.width;
            const imageHeight = this._image.height;

            const windowRatio = width / height;
            const imageRatio = imageWidth / imageHeight;

            if (windowRatio > imageRatio) {
                this._fullscreenImage.classList.add("tall");
            } else {
                this._fullscreenImage.classList.remove("tall");
            }
        }
    }

    MagnonImage.init();
</script>
